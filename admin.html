<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="admin-page">
    <div class="admin-grid">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Admin</h2>
            </div>
                <nav class="sidebar-nav">
                <ul>
                    <li class="active"><a href="admin.html">Dashboard</a></li>
                    <li><a href="https://sweetloou.github.io/PinkBellyGames/" target="_blank" rel="noopener">Website</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <header class="main-header">
                <h1>Dashboard Overview</h1>
            </header>
            <div class="stats-container">
                <div class="stat-box">
                    <h3>Visitors</h3>
                    <p id="visitors-count">0</p>
                </div>
                <div class="stat-box">
                    <h3>Subscribers</h3>
                    <p id="subscribers-count">0</p>
                </div>
            </div>
            <div class="content-panel">
                <div class="panel-header">
                    <h2>Subscribed Emails</h2>
                    <div>
                        <button id="refresh-button" class="button-primary">Refresh</button>
                        <button id="csv-button" class="button-secondary">Download as CSV</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="subscribers-list">
                            <!-- Subscriber rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const subscribersList = document.getElementById('subscribers-list');
            const subscribersCountEl = document.getElementById('subscribers-count');
            const visitorsCountEl = document.getElementById('visitors-count');
            const refreshButton = document.getElementById('refresh-button');
            const csvButton = document.getElementById('csv-button');

            const supabaseUrl = 'https://nabbbowykckcfsixxgws.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hYmJib3d5a2NrY2ZzaXh4Z3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTA3MDgsImV4cCI6MjA2Njc4NjcwOH0.NRILPviKwcDE1b7cvJxjSCAJZXp_2ox80WiT35QrpNg';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            async function fetchData() {
                try {
                    // Fetch stats
                    const { data: stats, error: statsError } = await supabase
                        .from('site_stats')
                        .select('value')
                        .eq('key', 'visitors')
                        .single();

                    if (statsError) throw statsError;
                    visitorsCountEl.textContent = stats.value;

                    const { count, error: subscribersError } = await supabase
                        .from('subscribers')
                        .select('*', { count: 'exact' });

                    if (subscribersError) throw subscribersError;
                    subscribersCountEl.textContent = count;

                    // Fetch subscribers
                    const { data: subscribers, error: subscribersListError } = await supabase
                        .from('subscribers')
                        .select('email, subscribed_at')
                        .order('subscribed_at', { ascending: false });

                    if (subscribersListError) throw subscribersListError;
                    
                    subscribersList.innerHTML = ''; // Clear existing list
                    
                    subscribers.forEach(subscriber => {
                        const row = document.createElement('tr');
                        const emailCell = document.createElement('td');
                        const dateCell = document.createElement('td');
                        
                        emailCell.textContent = subscriber.email;
                        
                        const utcDate = new Date(subscriber.subscribed_at);
                        dateCell.textContent = utcDate.toLocaleString();
                        
                        row.appendChild(emailCell);
                        row.appendChild(dateCell);
                        subscribersList.appendChild(row);
                    });

                } catch (error) {
                    console.error('Error:', error);
                    alert('Could not load dashboard data.');
                }
            }

            refreshButton.addEventListener('click', fetchData);

            csvButton.addEventListener('click', async () => {
                try {
                    const { data: subscribers, error } = await supabase
                        .from('subscribers')
                        .select('email, subscribed_at')
                        .order('subscribed_at', { ascending: false });

                    if (error) throw error;

                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Email,Time\n";

                    subscribers.forEach(s => {
                        const utcDate = new Date(s.subscribed_at);
                        const row = `${s.email},"${utcDate.toLocaleString()}"`;
                        csvContent += row + "\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "subscribers.csv");
                    document.body.appendChild(link); // Required for FF

                    link.click();
                    document.body.removeChild(link);

                } catch (error) {
                    console.error('Error generating CSV:', error);
                    alert('Could not generate CSV file.');
                }
            });

            // Initial fetch
            fetchData();
        });
    </script>
</body>
</html>
