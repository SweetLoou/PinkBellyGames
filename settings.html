<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="admin-page">
    <div class="admin-grid">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="admin.html">Dashboard</a></li>
                    <li><a href="https://sweetloou.github.io/PinkBellyGames/" target="_blank" rel="noopener">Website</a></li>
                    <li class="active"><a href="settings.html">Settings</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <header class="main-header">
                <h1>Settings</h1>
            </header>
            <div class="content-panel">
                <form id="settings-form">
                    <div class="form-group">
                        <label for="logo-upload">Logo</label>
                        <input type="file" id="logo-upload" name="logo" accept="image/*">
                        <img id="logo-preview" src="#" alt="Logo Preview">
                    </div>
                    <div class="form-group">
                        <label>Social Links</label>
                        <div id="social-links-container" class="scrollable-list">
                            <!-- Social link inputs will be dynamically added here -->
                        </div>
                        <button type="button" id="add-social-link" class="button-secondary">Add Social Link</button>
                    </div>
                    <button type="submit" class="button-primary">Save Settings</button>
                </form>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const settingsForm = document.getElementById('settings-form');
            const logoUpload = document.getElementById('logo-upload');
            const logoPreview = document.getElementById('logo-preview');
            const socialLinksContainer = document.getElementById('social-links-container');
            const addSocialLinkButton = document.getElementById('add-social-link');

            const supabaseUrl = 'https://nabbbowykckcfsixxgws.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hYmJib3d5a2NrY2ZzaXh4Z3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTA3MDgsImV4cCI6MjA2Njc4NjcwOH0.NRILPviKwcDE1b7cvJxjSCAJZXp_2ox80WiT35QrpNg';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // Load existing settings
            async function loadSettings() {
                try {
                    const { data, error } = await supabase
                        .from('settings')
                        .select('key, value');

                    if (error) throw error;

                    const settings = data.reduce((acc, row) => {
                        acc[row.key] = row.value;
                        return acc;
                    }, {});

                    if (settings.logo) {
                        logoPreview.src = settings.logo;
                        logoPreview.style.display = 'block';
                    }

                    if (settings.socials) {
                        settings.socials.forEach(addSocialLinkInput);
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }

            function addSocialLinkInput(link = { platform: '', url: '' }) {
                const div = document.createElement('div');
                div.classList.add('social-link-group');
                div.innerHTML = `
                    <input type="text" placeholder="Platform (e.g., twitter)" value="${link.platform}" class="social-platform">
                    <input type="url" placeholder="URL" value="${link.url}" class="social-url">
                    <button type="button" class="remove-social-link">Remove</button>
                `;
                socialLinksContainer.appendChild(div);
                div.querySelector('.remove-social-link').addEventListener('click', () => div.remove());
            }

            addSocialLinkButton.addEventListener('click', () => addSocialLinkInput());

            logoUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        logoPreview.src = e.target.result;
                        logoPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            settingsForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                try {
                    // Handle logo upload
                    const logoFile = logoUpload.files[0];
                    if (logoFile) {
                        const { data: uploadData, error: uploadError } = await supabase.storage
                            .from('public')
                            .upload(`logos/${Date.now()}_${logoFile.name}`, logoFile);

                        if (uploadError) throw uploadError;

                        const { data: urlData } = supabase.storage.from('public').getPublicUrl(uploadData.path);
                        
                        const { error: dbError } = await supabase
                            .from('settings')
                            .update({ value: `"${urlData.publicUrl}"` })
                            .eq('key', 'logo');

                        if (dbError) throw dbError;
                    }

                    // Handle social links
                    const socialLinks = [];
                    socialLinksContainer.querySelectorAll('.social-link-group').forEach(group => {
                        const platform = group.querySelector('.social-platform').value;
                        const url = group.querySelector('.social-url').value;
                        if (platform && url) {
                            socialLinks.push({ platform, url });
                        }
                    });

                    const { error: socialsError } = await supabase
                        .from('settings')
                        .update({ value: JSON.stringify(socialLinks) })
                        .eq('key', 'socials');

                    if (socialsError) throw socialsError;

                    alert('Settings saved successfully!');

                } catch (error) {
                    console.error('Error saving settings:', error);
                    alert('Failed to save settings.');
                }
            });

            loadSettings();
        });
    </script>
</body>
</html>
